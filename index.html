<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>SMART Attendance - Session + Refresh + View Attendance Button</title>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root { --mmu-blue:#0a2f5a; --mmu-red:#ce2029; --bg:#f4f7f9; }
    body { margin:0; background:var(--mmu-blue); font-family:'Segoe UI', Arial, sans-serif; display:flex; justify-content:center; }
    .app-container { width:100%; max-width:420px; min-height:100vh; background:var(--bg); display:flex; flex-direction:column; }
    .header { background:var(--mmu-blue); color:#fff; padding:15px; text-align:center; font-weight:bold; border-bottom:3px solid var(--mmu-red); }
    .page { display:none; padding:20px; flex:1; flex-direction:column; text-align:center; }
    .active { display:flex; }
    .card { background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:15px; }
    input, select, button { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:15px; }
    button { background:var(--mmu-red); color:#fff; border:none; font-weight:bold; cursor:pointer; }
    .btn-grey { background:#555; }
    #qr-reader { width:100% !important; border-radius:10px; margin-bottom:10px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #ddd; }
    .fraud-alert { color:red; font-weight:bold; margin-top:5px; }
    .small { font-size:12px; color:#666; }
  </style>
</head>

<body>
<div class="app-container">
  <div class="header">SMART Attendance System</div>

  <!-- Login Page -->
  <div id="loginPage" class="page active">
    <div class="card">
      <h3>Login</h3>
      <select id="role">
        <option value="student">Student</option>
        <option value="lecturer">Lecturer</option>
        <option value="admin">Admin</option>
      </select>

      <input id="email" placeholder="Enter Email (e.g mike@mmu.edu.my)" />
      <input id="password" type="password" placeholder="Password (123456)" />

      <button onclick="handleLogin()">Login</button>
      <button class="btn-grey" onclick="refreshCurrentPage()">Refresh</button>

      <p class="small">Demo: Student = mike/desmond, Lecturer/Admin = any</p>
    </div>
  </div>

  <!-- Student Page -->
  <div id="studentPage" class="page">
    <div class="card">
      <h3>Welcome, <span id="studentName"></span></h3>

      <button class="btn-grey" onclick="refreshCurrentPage()">Refresh</button>

      <!-- Main student actions -->
      <div id="studentActions">
        <button onclick="startScanning()">Scan Attendance</button>
        <button class="btn-grey" onclick="showHistory()">View History</button>
      </div>

      <!-- Camera view -->
      <div id="reader-container" style="display:none;">
        <div id="qr-reader"></div>
      </div>

      <!-- This button will change:
           - During scan: Cancel Scan
           - After success: View Attendance
           Hidden when not needed -->
      <button class="btn-grey" id="scanActionBtn" style="display:none;">Cancel Scan</button>

      <!-- History panel -->
      <div id="personalHistory" style="display:none;">
        <h4>My Records</h4>
        <div id="historyList"></div>
      </div>

      <button class="btn-grey" onclick="logout()" style="margin-top:auto;">Logout</button>
    </div>
  </div>

  <!-- Lecturer Page -->
  <div id="lecturerPage" class="page">
    <div class="card">
      <h3>Lecturer: Liang</h3>

      <button class="btn-grey" onclick="refreshCurrentPage()">Refresh</button>

      <select id="sessionSelect">
        <option value="">-- Select Session --</option>
        <option value="Software Engineering">Software Engineering</option>
        <option value="OOAD">OOAD</option>
        <option value="Networking">Networking</option>
      </select>

      <div id="qrcode" style="display:flex; justify-content:center; margin:10px 0;"></div>
      <p id="timer" style="color:var(--mmu-red); font-weight:bold;">Token status: Ready</p>

      <button onclick="startLecturerSession()">Start Class session</button>
    </div>

    <div class="card">
      <h4>Live Attendance List</h4>
      <table>
        <thead>
          <tr><th>Student</th><th>Status</th><th>Session</th><th>Time</th></tr>
        </thead>
        <tbody id="attendanceList"></tbody>
      </table>
    </div>

    <button class="btn-grey" onclick="logout()" style="margin-top:auto;">Logout</button>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="page">
    <div class="card">
      <h3>Admin Dashboard</h3>

      <button class="btn-grey" onclick="refreshCurrentPage()">Refresh</button>
      <button onclick="clearLogs()" class="btn-grey">Clear Logs</button>

      <h4>Audit & Fraud Logs</h4>
      <div id="auditLogs"></div>
    </div>

    <button class="btn-grey" onclick="logout()" style="margin-top:auto;">Logout</button>
  </div>

  <!-- Done Page -->
  <div id="donePage" class="page">
    <div class="card">
      <h3>Attendance Verified ✅</h3>

      <button class="btn-grey" onclick="refreshCurrentPage()">Refresh</button>

      <div id="forensicSummary"></div>
      <button onclick="showPage('studentPage')">Back</button>
    </div>
  </div>
</div>

<script>
  let currentUser = "";
  let activeSession = "";
  let html5QrCode = null;

  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    refreshCurrentPage(); // auto refresh when entering a page
  }

  // Refresh page data
  function refreshCurrentPage() {
    const active = document.querySelector(".page.active");
    if (!active) return;

    const id = active.id;

    if (id === "studentPage") {
      // If history is open, refresh it
      const panel = document.getElementById("personalHistory");
      if (panel && panel.style.display !== "none") showHistory(true);
    }

    if (id === "lecturerPage") updateLecturerTable();
    if (id === "adminPage") loadAuditLogs();
  }

  // --- Login Logic ---
  function handleLogin() {
    const role = document.getElementById("role").value;
    const email = document.getElementById("email").value.trim().toLowerCase();
    if (document.getElementById("password").value !== "123456") { alert("Wrong Password"); return; }

    if (role === "student" && (email.includes("mike") || email.includes("desmond"))) {
      currentUser = email.includes("mike") ? "MIKE" : "DESMOND";
      document.getElementById("studentName").innerText = currentUser;

      // Reset student UI
      hideScanActionBtn();
      document.getElementById("reader-container").style.display = "none";
      document.getElementById("studentActions").style.display = "block";

      showPage("studentPage");
    } else if (role === "lecturer") {
      showPage("lecturerPage");
    } else if (role === "admin") {
      showPage("adminPage");
    } else {
      alert("Invalid credentials for demo.");
    }
  }

  // --- Student: Scan Button Modes ---
  function showScanActionBtn(label, handler) {
    const btn = document.getElementById("scanActionBtn");
    btn.style.display = "block";
    btn.innerText = label;
    btn.onclick = handler;
  }
  function hideScanActionBtn() {
    const btn = document.getElementById("scanActionBtn");
    btn.style.display = "none";
    btn.innerText = "Cancel Scan";
    btn.onclick = null;
  }

  // --- Student Scanning ---
  function startScanning() {
    // Show camera
    document.getElementById("reader-container").style.display = "block";
    document.getElementById("studentActions").style.display = "none";

    // IMPORTANT: During scanning, button = Cancel Scan
    showScanActionBtn("Cancel Scan", stopScanning);

    html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 200 },
      token => processAttendance(token),
      () => {}
    ).catch(() => {
      alert("Camera access blocked.");
      // If camera fails, restore UI
      document.getElementById("reader-container").style.display = "none";
      document.getElementById("studentActions").style.display = "block";
      hideScanActionBtn();
    });
  }

  function stopScanning() {
    // Cancel scan
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById("reader-container").style.display = "none";
        document.getElementById("studentActions").style.display = "block";
        hideScanActionBtn(); // hide button when not scanning
      }).catch(() => {
        document.getElementById("reader-container").style.display = "none";
        document.getElementById("studentActions").style.display = "block";
        hideScanActionBtn();
      });
    } else {
      document.getElementById("reader-container").style.display = "none";
      document.getElementById("studentActions").style.display = "block";
      hideScanActionBtn();
    }
  }

  // ✅ After successful scan:
  // - stop camera
  // - hide camera UI
  // - show button = View Attendance (replacing Cancel Scan)
  function processAttendance(token) {
    html5QrCode.stop().then(() => {

      // Extract session from token: TOKEN-xxxxx|SESSION=Software%20Engineering
      let sessionName = "Unknown";
      const parts = token.split("|SESSION=");
      if (parts.length === 2) sessionName = decodeURIComponent(parts[1]);

      const isFraud = Math.random() > 0.8;
      const record = {
        name: currentUser,
        time: new Date().toLocaleTimeString(),
        ip: "172.16." + Math.floor(Math.random() * 255) + ".12",
        geo: isFraud ? "Unknown/VPN" : "MMU Cyberjaya",
        fraud: isFraud,
        session: sessionName
      };

      let logs = JSON.parse(localStorage.getItem("smart_records")) || [];

      // Prevent duplicate scan PER SESSION
      if (!logs.find(l => l.name === currentUser && l.session === sessionName)) {
        logs.push(record);
        localStorage.setItem("smart_records", JSON.stringify(logs));
      }

      // Prepare attendance summary for Done page
      document.getElementById("forensicSummary").innerHTML = `
        <b>Student:</b> ${record.name}<br>
        <b>Session:</b> ${record.session}<br>
        <b>Time:</b> ${record.time}<br>
        <b>Location:</b> ${record.geo}
      `;

      // Close camera UI and show normal actions again
      document.getElementById("reader-container").style.display = "none";
      document.getElementById("studentActions").style.display = "block";

      // ✅ Change "Cancel Scan" button into "View Attendance"
      showScanActionBtn("View Attendance", () => showPage("donePage"));
    }).catch(() => {
      alert("Scan failed. Try again.");
      stopScanning();
    });
  }

  // --- Lecturer Logic ---
  function startLecturerSession() {
    const selected = document.getElementById("sessionSelect").value;
    if (!selected) { alert("Please select a session before starting."); return; }

    activeSession = selected;

    document.getElementById("qrcode").innerHTML = "";
    const token = "TOKEN-" + Date.now() + "|SESSION=" + encodeURIComponent(activeSession);
    new QRCode(document.getElementById("qrcode"), { text: token, width: 180, height: 180 });

    document.getElementById("timer").innerText = "Session: " + activeSession + " (Token refreshes every 3 mins)";
    updateLecturerTable();
  }

  function updateLecturerTable() {
    const tbody = document.getElementById("attendanceList");
    if (!tbody) return;
    tbody.innerHTML = "";

    let records = JSON.parse(localStorage.getItem("smart_records")) || [];

    ["MIKE", "DESMOND"].forEach(s => {
      let r = null;

      if (activeSession) {
        r = records.find(x => x.name === s && x.session === activeSession);
      } else {
        const all = records.filter(x => x.name === s);
        r = all.length ? all[all.length - 1] : null;
      }

      const status = r ? `<b style="color:green">PRESENT</b>` : `<b style="color:red">ABSENT</b>`;
      const time = r ? r.time : "--";
      const sess = r ? (r.session || "--") : (activeSession || "--");

      tbody.innerHTML += `<tr><td>${s}</td><td>${status}</td><td>${sess}</td><td>${time}</td></tr>`;
    });
  }

  // --- Admin Logic ---
  function loadAuditLogs() {
    const logBox = document.getElementById("auditLogs");
    if (!logBox) return;

    let records = JSON.parse(localStorage.getItem("smart_records")) || [];
    logBox.innerHTML = records.slice().reverse().map(r => `
      <div style="border-bottom:1px solid #ccc; padding:5px;">
        [${r.time}] <b>${r.name}</b> scanned.<br>
        <b>Session:</b> ${r.session || "Unknown"}<br>
        Device IP: ${r.ip} | Geo: ${r.geo}
        ${r.fraud ? '<div class="fraud-alert">⚠ POSSIBLE FRAUD DETECTED</div>' : ''}
      </div>
    `).join("");
  }

  function clearLogs() {
    localStorage.removeItem("smart_records");
    loadAuditLogs();
    updateLecturerTable();
    alert("Logs cleared!");
  }

  function showHistory(forceRefresh = false) {
    document.getElementById("personalHistory").style.display = "block";
    const list = document.getElementById("historyList");

    let records = JSON.parse(localStorage.getItem("smart_records")) || [];
    const myRecords = records.filter(r => r.name === currentUser).reverse();

    if (!myRecords.length) {
      list.innerHTML = `<p>❌ No record found</p>`;
      return;
    }

    list.innerHTML = myRecords.map(r =>
      `<p>✅ ${r.session || "Unknown"} — ${r.time}</p>`
    ).join("");
  }

  function logout() { location.reload(); }
</script>
</body>
</html>
